$(document).ready(function(){typeof $.fn.select2<"u"&&$(".select2").select2();const a=$("#select-all-logs"),n=$(".log-checkbox"),d=$("#bulk-delete-btn"),g=$("#toggle-select-all-btn"),k=$(".bulk-actions"),p=$("#form-feedback");i(),b(),s(),f();function i(){$.fn.datepicker&&$(".datepicker").datepicker({format:"yyyy-mm-dd",autoclose:!0,language:"ar",rtl:!0}),$.fn.select2&&$(".select2").select2({dir:"rtl",placeholder:"اختر...",allowClear:!0}),$.fn.DataTable&&$(".security-logs-table").DataTable({language:{url:"//cdn.datatables.net/plug-ins/1.10.24/i18n/Arabic.json"},order:[[1,"desc"]],pageLength:15})}function b(){g.on("click",function(){const e=a.prop("checked");a.prop("checked",!e),n.prop("checked",!e),l(!e),y(!e)}),a.on("change",function(){const e=$(this).prop("checked");n.prop("checked",e),l(e)}),n.on("change",function(){const e=n.filter(":checked").length,o=n.length;a.prop("checked",e===o),l(e>0)}),d.on("click",t)}function l(e){const o=n.filter(":checked").length;k.toggleClass("show",e),e&&k.find(".selected-count").text(o),d.toggleClass("d-none",!e)}function y(e){g.html(e?'<i class="ri-checkbox-multiple-blank-line me-1"></i> إلغاء تحديد الكل':'<i class="ri-checkbox-multiple-line me-1"></i> تحديد الكل')}function t(){const e=r();if(e.length===0){m("error","الرجاء تحديد السجلات التي تريد حذفها");return}if(!confirm("هل أنت متأكد من حذف السجلات المحددة؟"))return;const o=E(d);$.ajax({url:$("#bulk-destroy-form").attr("action"),method:"POST",data:{_token:$('meta[name="csrf-token"]').attr("content"),ids:e.join(",")},beforeSend:()=>{o.start(),p.removeClass("d-none success error")},success:c=>{c.success?(m("success",c.message),setTimeout(()=>window.location.reload(),1500)):m("error",c.message)},error:c=>{var h;const u=((h=c.responseJSON)==null?void 0:h.message)||"حدث خطأ أثناء حذف السجلات";m("error",u)},complete:()=>{o.stop()}})}function s(){const e=$("#filter-form");e.on("submit",function(o){o.preventDefault();const c=new FormData(this);$.ajax({url:e.attr("action"),method:"GET",data:c,processData:!1,contentType:!1,success:u=>{$("#logs-table-container").html(u),i()},error:u=>{m("error","حدث خطأ أثناء تصفية النتائج")}})}),e.find("select, input").on("change",function(){e.submit()})}function f(){$(".export-excel").on("click",function(e){e.preventDefault();const o={event_type:$("#event-type-filter").val(),status:$("#status-filter").val(),date_from:$("#date-from").val(),date_to:$("#date-to").val()},c=Object.entries(o).filter(([h,C])=>C).map(([h,C])=>`${h}=${encodeURIComponent(C)}`).join("&"),u=window.exportUrl+(c?`?${c}`:"");window.location.href=u})}function r(){return Array.from(n.filter(":checked")).map(e=>e.value)}function m(e,o){p.removeClass("d-none success error").addClass(e).html(o).fadeIn()}function E(e){const o=e.html(),c='<i class="fas fa-spinner fa-spin"></i> جاري الحذف...';return{start:()=>{e.prop("disabled",!0).html(c)},stop:()=>{e.prop("disabled",!1).html(o)}}}});document.addEventListener("DOMContentLoaded",function(){var y;$(".select2").select2(),$(".flatpickr").flatpickr({dateFormat:"Y-m-d",locale:"ar"});const a=document.querySelector(".bulk-actions"),n=document.getElementById("select-all-logs"),d=document.querySelectorAll(".log-checkbox"),g=document.querySelector(".selected-count"),k=document.getElementById("bulk-destroy-form"),p=document.getElementById("bulk-destroy-ids"),i=document.getElementById("form-feedback");function b(){const t=document.querySelectorAll(".log-checkbox:checked").length;g.textContent=t,t>0?a.classList.remove("d-none"):(a.classList.add("d-none"),n.checked=!1)}n==null||n.addEventListener("change",function(){d.forEach(t=>{t.checked=this.checked}),b()}),d.forEach(t=>{t.addEventListener("change",function(){b();const s=document.querySelectorAll(".log-checkbox:not(:checked)").length===0;n.checked=s})}),(y=document.getElementById("bulk-delete-btn"))==null||y.addEventListener("click",function(){if(confirm("هل أنت متأكد من حذف السجلات المحددة؟")){const t=Array.from(document.querySelectorAll(".log-checkbox:checked")).map(s=>s.value);p.value=JSON.stringify(t),k.submit()}}),document.querySelectorAll(".toggle-resolution-btn").forEach(t=>{t.addEventListener("click",async function(){const s=this.dataset.logId;try{const r=await(await fetch(`/dashboard/security/logs/${s}/toggle-resolution`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content}})).json();r.success?(l("success",r.message),setTimeout(()=>window.location.reload(),1500)):l("error",r.message||"حدث خطأ أثناء تحديث الحالة")}catch{l("error","حدث خطأ أثناء الاتصال بالخادم")}})}),document.querySelectorAll(".delete-log-btn").forEach(t=>{t.addEventListener("click",async function(){if(!confirm("هل أنت متأكد من حذف هذا السجل؟"))return;const s=this.dataset.logId;try{const r=await(await fetch(`/dashboard/security/logs/${s}`,{method:"DELETE",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content}})).json();r.success?(l("success",r.message),setTimeout(()=>window.location.reload(),1500)):l("error",r.message||"حدث خطأ أثناء حذف السجل")}catch{l("error","حدث خطأ أثناء الاتصال بالخادم")}})});function l(t,s){i.className=`alert alert-${t==="success"?"success":"danger"}`,i.textContent=s,i.classList.remove("d-none"),setTimeout(()=>{i.classList.add("d-none")},3e3)}});
